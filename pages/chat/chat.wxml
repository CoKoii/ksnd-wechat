<!-- pages/chat/chat.wxml -->
<view class="page">
  <view class="sidebar-mask {{sidebarOpen ? 'sidebar-mask--show' : ''}}" bindtap="closeSidebar"></view>
  <view class="sidebar {{sidebarOpen ? 'sidebar--open' : ''}}" style="padding-top: {{statusBarHeight}}px;">
    <view class="sidebar-header">
      <view class="sidebar-title">{{uiText.sidebarTitle}}</view>
      <view class="sidebar-new" bindtap="onNewChat">
        <view class="icon-circle icon-circle--small">
          <view class="icon-plus icon-plus--h"></view>
          <view class="icon-plus icon-plus--v"></view>
        </view>
      </view>
    </view>
    <scroll-view class="sidebar-list" scroll-y="true" show-scrollbar="false">
      <view class="sidebar-empty" wx:if="{{conversations.length === 0}}">{{uiText.sidebarEmpty}}</view>
      <block wx:for="{{conversations}}" wx:key="id">
        <view
          class="sidebar-item {{item.id === activeConversationId ? 'sidebar-item--active' : ''}}"
          bindtap="onSelectConversation"
          data-id="{{item.id}}"
        >
          <view class="sidebar-item-title">{{item.title}}</view>
          <view class="sidebar-item-time">{{item.updatedAtText}}</view>
        </view>
      </block>
    </scroll-view>
  </view>

  <view class="nav" style="padding-top: {{statusBarHeight}}px; height: {{navHeight}}px;">
    <view class="nav-left" style="width: {{navSideWidth}}px;" bindtap="onBack">
      <view class="icon-back">
        <view class="icon-back__line icon-back__line--top"></view>
        <view class="icon-back__line icon-back__line--bottom"></view>
      </view>
    </view>
    <view class="nav-title nav-title--clickable" bindtap="openSidebar">
      <text class="nav-title__text">{{navTitle}}</text>
      <view class="nav-title__chevron"></view>
    </view>
    <view class="nav-right nav-right--spacer" style="width: {{navSideWidth}}px;"></view>
  </view>

  <scroll-view
    class="content"
    scroll-y="true"
    scroll-with-animation="true"
    scroll-into-view="{{scrollTargetId}}"
    scroll-top="{{scrollTop}}"
    enable-flex="true"
    show-scrollbar="false"
    style="height: {{contentHeight}}px;"
  >
    <view class="content-inner">
      <view class="empty" wx:if="{{messages.length === 0}}">
        <image class="empty-logo" src="./assets/whale.svg" mode="aspectFit" />
        <view class="empty-text">{{uiText.emptyTitle}}</view>
      </view>

      <view class="message-list" wx:else>
        <block wx:for="{{messages}}" wx:key="id">
          <view class="message message--{{item.role}}" id="msg-{{item.id}}">
            <view class="bubble">
              <view wx:if="{{item.pending && !item.html && !item.structured}}" class="typing">
                <view class="typing-dot"></view>
                <view class="typing-dot typing-dot--middle"></view>
                <view class="typing-dot"></view>
              </view>
              <block wx:else>
                <image
                  wx:if="{{item.imageUrl}}"
                  class="bubble-image"
                  src="{{item.imageUrl}}"
                  mode="aspectFill"
                  data-url="{{item.imageUrl}}"
                  bindtap="onPreviewMessageImage"
                />

                <view wx:if="{{item.structured}}" class="result-card">
                  <view class="result-row">
                    <text class="result-label">1. 设备类型</text>
                    <text class="result-value">{{item.structured.deviceType || '--'}}</text>
                  </view>
                  <view class="result-row">
                    <text class="result-label">2. 隐患归类详情</text>
                    <text class="result-value">{{item.structured.hazardDetail || '--'}}</text>
                  </view>
                  <view class="result-row result-row--block">
                    <text class="result-label">3. 截取的法规</text>
                    <view wx:if="{{item.structured.regulations.length > 0}}" class="result-regulation-list">
                      <block wx:for="{{item.structured.regulations}}" wx:key="index" wx:for-item="regulation">
                        <text class="result-regulation">{{index + 1}}. {{regulation}}</text>
                      </block>
                    </view>
                    <text wx:else class="result-value">--</text>
                  </view>
                  <view wx:if="{{item.structured.referenceImages.length > 0}}" class="result-row result-row--block">
                    <text class="result-label">法规图示</text>
                    <view class="result-image-list">
                      <block wx:for="{{item.structured.referenceImages}}" wx:key="url" wx:for-item="refImage">
                        <view class="result-image-card">
                          <image
                            class="result-image"
                            src="{{refImage.url}}"
                            mode="aspectFill"
                            data-url="{{refImage.url}}"
                            bindtap="onPreviewMessageImage"
                          />
                          <text class="result-image-label">{{refImage.label}}</text>
                        </view>
                      </block>
                    </view>
                  </view>
                  <view class="result-row">
                    <text class="result-label">4. 位置</text>
                    <text class="result-value">{{item.structured.location || '--'}}</text>
                  </view>
                  <view class="result-row result-row--block">
                    <text class="result-label">5. 图片解析</text>
                    <text class="result-value">{{item.structured.imageAnalysis || '--'}}</text>
                    <text wx:if="{{item.structured.imageItem}}" class="result-sub">
                      识别对象：{{item.structured.imageItem}}
                    </text>
                  </view>
                </view>

                <rich-text wx:if="{{item.html && !item.structured}}" class="markdown" nodes="{{item.html}}"></rich-text>
              </block>
            </view>
          </view>
        </block>
      </view>

      <view class="scroll-spacer" style="height: {{scrollSpacerHeight}}px;"></view>
    </view>
  </scroll-view>

  <view class="composer" style="padding-bottom: {{safeAreaBottom}}px;">
    <view class="composer-card">
      <view class="composer-limit">{{uiText.inputLimitTip}}</view>

      <view wx:if="{{selectedImage.url}}" class="composer-selected">
        <image
          class="composer-selected__image"
          src="{{selectedImage.url}}"
          mode="aspectFill"
          bindtap="onPreviewSelectedImage"
        />
        <view class="composer-selected__remove" catchtap="onRemoveSelectedImage">x</view>
      </view>

      <view class="composer-input-row">
        <input
          class="composer-input"
          value="{{inputValue}}"
          placeholder="{{uiText.placeholder}}"
          placeholder-class="composer-placeholder"
          confirm-type="send"
          bindinput="onInput"
          bindconfirm="onConfirm"
        />
      </view>

      <view class="composer-actions">
        <view class="chip" bindtap="onAttachTap">
          <view class="chip-icon chip-icon--upload"></view>
          <text>{{uiText.uploadHint}}</text>
        </view>
        <view class="composer-spacer"></view>
        <view class="send-btn {{isSending ? 'send-btn--disabled' : ''}}" bindtap="onSendTap">
          <text>{{uiText.send}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
