<!--pages/checkInfo/checkInfo.wxml-->
<scroll-view class="page-container" scroll-y>
  <!-- 提示信息 -->
  <view class="tip-box">
    <view class="tip-bar" />
    <view class="tip-text">请巡检人员按照要求认真巡检</view>
  </view>

  <view class="section" wx:if="{{taskDetail}}">
    <view class="section-title">任务信息</view>
    <view class="task-info">
      <view class="task-row">
        <text class="task-label">任务名称：</text>
        <text class="task-value">{{taskDetail.name || '--'}}</text>
      </view>
      <view class="task-row">
        <text class="task-label">计划名称：</text>
        <text class="task-value">{{taskDetail.plname || '--'}}</text>
      </view>
      <view class="task-row">
        <text class="task-label">商铺：</text>
        <text class="task-value">{{taskDetail.coname || '--'}}</text>
      </view>
      <view class="task-row">
        <text class="task-label">发布人：</text>
        <text class="task-value">{{taskDetail.publisher || '--'}}</text>
      </view>
      <view class="task-row">
        <text class="task-label">状态：</text>
        <text class="task-value">{{taskDetail.stname || '--'}}</text>
      </view>
      <view class="task-row">
        <text class="task-label">要求巡查日期：</text>
        <text class="task-value">{{taskDetail.requiredDate || '--'}}</text>
      </view>
    </view>
  </view>

  <view class="section shoot-entry" wx:if="{{taskDetail}}" bindtap="goToCasualShootList">
    <view class="entry-main">
      <view class="entry-title">随手拍</view>
      <view class="entry-desc">进入随手拍列表</view>
    </view>
    <view class="entry-arrow">
      <van-icon name="arrow" color="#999" size="20px" />
    </view>
  </view>

  <!-- 巡检结果 -->
  <view class="section">
    <view class="section-title">巡检结果</view>
    <view class="result-group">
      <van-radio-group
        value="{{checkResult}}"
        bind:change="onCheckResultChange"
        direction="horizontal">
        <van-radio name="normal" checked-color="#52c41a">
          <text class="result-label {{checkResult === 'normal' ? 'is-normal' : ''}}">正常</text>
        </van-radio>
        <van-radio name="abnormal" checked-color="#ff4d4f">
          <text class="result-label {{checkResult === 'abnormal' ? 'is-abnormal' : ''}}">异常</text>
        </van-radio>
      </van-radio-group>
      <view
        class="result-group-mask"
        wx:if="{{readonly}}"
        catchtap="onReadonlyResultTap" />
    </view>
  </view>

  <!-- 检查项 -->
  <view class="section">
    <view class="section-title">检查项</view>
    <view class="check-items">
      <view class="check-item {{item.status === 'ignore' ? 'is-ignore' : ''}}" wx:for="{{checkItems}}" wx:key="id">
        <view class="check-item-header">
          <text class="check-item-name">{{item.name}}</text>
          <view class="check-item-actions" wx:if="{{!readonly}}">
            <view 
              class="action-btn {{item.status === true ? 'active' : ''}}" 
              data-index="{{index}}"
              data-action="normal"
              bindtap="onCheckItemAction">
              <van-icon name="success" color="{{item.status === true ? '#52c41a' : '#ccc'}}" size="16" />
            </view>
            <view 
              class="action-btn error {{item.status === false ? 'active' : ''}}" 
              data-index="{{index}}"
              data-action="abnormal"
              bindtap="onCheckItemAction">
              <van-icon name="cross" color="{{item.status === false ? '#ff4d4f' : '#ccc'}}" size="16" />
            </view>
            <view
              class="action-btn ignore {{item.status === 'ignore' ? 'active' : ''}}"
              data-index="{{index}}"
              data-action="ignore"
              bindtap="onCheckItemAction">
              <van-icon name="minus" color="{{item.status === 'ignore' ? '#666' : '#ccc'}}" size="16" />
            </view>
          </view>
          <text class="check-item-status normal" wx:if="{{readonly && item.status === true}}">正常</text>
          <text class="check-item-status abnormal" wx:if="{{readonly && item.status === false}}">异常</text>
          <text class="check-item-status ignore" wx:if="{{readonly && item.status === 'ignore'}}">不涉及</text>
          <text class="check-item-status" wx:if="{{readonly && item.status === null}}">未巡检</text>
        </view>
        
        <!-- 异常信息显示 -->
        <view class="abnormal-info" wx:if="{{item.status === false}}">
          <view class="abnormal-desc">{{item.description}}</view>
          <view class="abnormal-images" wx:if="{{item.images.length}}">
            <image 
              class="abnormal-image" 
              wx:for="{{item.images}}" 
              wx:key="index"
              wx:for-item="img"
              src="{{img.url}}" 
              mode="aspectFill" />
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 情况说明 -->
  <view class="section">
    <view class="section-title">情况说明</view>
    <textarea
      class="textarea-input"
      value="{{description}}"
      placeholder="请输入说明"
      maxlength="500"
      show-confirm-bar="{{false}}"
      disabled="{{readonly}}"
      bindinput="onDescriptionChange" />
  </view>

  <!-- 现场照片 -->
  <view class="section">
    <view class="section-title">现场照片（选填）</view>
    <van-uploader
      file-list="{{images}}"
      bind:after-read="onUploadImage"
      bind:delete="onDeleteImage"
      disabled="{{readonly}}"
      show-upload="{{!readonly}}"
      multiple />
  </view>

  <!-- 巡检人员姓名 -->
  <view class="section">
    <view class="section-title">巡检人员姓名</view>
    <input
      class="text-input"
      value="{{inspector}}"
      placeholder="请输入姓名"
      disabled="{{readonly}}"
      bindinput="onInspectorChange" />
  </view>
  
  <!-- 提交按钮 -->
  <view class="submit-section" wx:if="{{!readonly}}">
    <button class="submit-btn" bindtap="onSubmit">提交巡检结果</button>
  </view>
</scroll-view>

<!-- 异常说明弹窗 -->
<view class="modal-mask" wx:if="{{showAbnormalDialog}}" bindtap="onCancelAbnormal" />
<view class="modal-dialog" wx:if="{{showAbnormalDialog}}">
  <view class="modal-content">
    <view class="modal-header">
      <view class="modal-title">异常说明</view>
      <view class="modal-close" bindtap="onCancelAbnormal">×</view>
    </view>
    
    <view class="modal-body">
      <textarea
        class="form-textarea"
        value="{{tempDescription}}"
        placeholder="请输入说明"
        maxlength="200"
        show-confirm-bar="{{false}}"
        disabled="{{readonly}}"
        bindinput="onAbnormalDescChange" />
      
      <view class="upload-section">
        <view class="upload-label">上传照片（选填）</view>
        <van-uploader
          file-list="{{tempImages}}"
          bind:after-read="onUploadAbnormalImage"
          bind:delete="onDeleteAbnormalImage"
          disabled="{{readonly}}"
          show-upload="{{!readonly}}"
          multiple />
      </view>
    </view>

    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="onCancelAbnormal">取消</button>
      <button class="modal-btn confirm" bindtap="onConfirmAbnormal" wx:if="{{!readonly}}">确认</button>
    </view>
  </view>
</view>
